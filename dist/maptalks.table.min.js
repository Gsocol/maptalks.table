/*!
 * maptalks.table v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks$1)}(this,function(t,e){"use strict";function i(t,e){for(var i=Object.getOwnPropertyNames(e),o=0;o<i.length;o++){var r=i[o],s=Object.getOwnPropertyDescriptor(e,r);s&&s.configurable&&void 0===t[r]&&Object.defineProperty(t,r,s)}return t}var o=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):i(t,e))},s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},a={title:"title",columns:[{header:"Name",dataIndex:"name",type:"string"},{header:"Birth",dataIndex:"birth",type:"data"},{header:"Age",dataIndex:"age",type:"number"},{header:"Marry",dataIndex:"marry",type:"boolean",trueText:"Yes",falseText:"No"}],data:[{name:"Tom",birth:"1990-1-1",age:25,marry:"true"},{name:"Peter",birth:"1985-5-1",age:30,marry:"true"},{name:"Mary",birth:"2000-6-1",age:15,marry:"false"}],headerSymbol:{lineColor:"#ffffff",fill:"#4e98dd",textFaceName:"monospace",textSize:12,textFill:"#ebf2f9",textWrapWidth:100},symbol:{lineColor:"#ffffff",fill:"#4e98dd",textFaceName:"monospace",textSize:12,textFill:"#ebf2f9",textWrapWidth:100},position:{x:121.489935,y:31.24432},width:300,height:300,draggable:!0,editable:!0,header:!0,order:!0,startNum:1,dynamic:!1,layerId:null},n={NEED_DATA:"You must set data to Table options.",NEED_COLUMN:"You must set columns to Table options."},h=function(t){function e(i){var r;o(this,e);var a=s(this,t.call(this,i));if(a.options.width||(a.options.width=300),a.options.height||(a.options.width=300),a.options.header||a.options.header===!1||(a.options.header=!0),a.options.order||a.options.order===!1||(a.options.order=!0),a.options.visible=!0,a.options.editing=!1,a.options.showOrderNumber=!0,a.options.startNum=a.options.startNum||1,!a.options.data&&0===a.options.data.length)throw new Error(n.NEED_DATA);if(!a.options.columns&&0===a.options.columns.length)throw new Error(n.NEED_COLUMN);var h=a.options.orderTitle;if(h||(h="No."),a.options.order){var l=parseInt(a.options.startNum),d={header:h,dataIndex:"maptalks_order",type:"number"};a.options.columns.unshift(d);for(var _=a.options.data,c=0,g=_.length;c<g;c++)_[c].maptalks_order=c+l}return a._initalColumns=a.options.columns,a._headAttributes=a.options.attributes,a._columns=a.getColumns(),a._colNum=a._columns.length,a._data=a.options.data,a._initalData=a.options.data,a._rowNum=a._data.length,a.options.header&&(a._rowNum+=1),a.tableWidth=a.options.width||100,a.tableHeight=0,a._cellWidth=a.options.width/a._colNum,a._cellHeight=a.options.height/a._rowNum,a._currentRow=-1,a._currentCol=-1,a._geometryNumLabels=[],a._rowHeights=[],a._colWidths=[],r=a,s(a,r)}return r(e,t),e.prototype.toJSON=function(){return{options:this.options,colums:this._columns,attributes:this._headAttributes,colNum:this._colNum,data:this._dataToJSON(),rowNum:this._rowNum,rowHeights:this._rowHeights,colWidths:this._colWidths,tableWidth:this.tableWidth,tableHeight:this.tableHeight,tableSymbols:this.tableSymbols}},e.prototype._dataToJSON=function(){var t=[];if(this.options.dynamic&&this._data&&this._data.length>0)for(var e,i=0,o=this._data.length;i<o;i++)e=this._data[i],t.push(e);else t=this._data;return t},e.prototype.initByJson=function(t){var e=t.options;this._columns=t.colums,this._colNum=t.colNum,this._headAttributes=t.attributes,this._data=[];var i=t.data;if(e.dynamic&&i&&i.length>0)for(var o,r,s,a=0,n=i.length;a<n;a++)o=i[a],r=o.geometry,r&&(s=maptalks.Geometry.fromJSON(r),o.coordinate=s.getCenter(),o.geometry=null,delete o.geometry),this._data.push(o);else this._data=i;return this._rowNum=t.rowNum,this._rowHeights=t.rowHeights,this._colWidths=t.colWidths,this.tableWidth=t.tableWidth,this._tableRows=this._data,this.tableSymbols=t.tableSymbols,this},e.prototype.getId=function(){return this.options.id},e.prototype.isDynamic=function(){return this.options.dynamic},e.prototype.getLayerId=function(){return this.options.layerId},e.prototype.getType=function(){return"MAPTALKS_TABLE"},e.prototype.getData=function(){for(var t=[],e=0;e<this._data.length;e++)t.push(this._data[e]);return t},e.prototype.getDataByRowNum=function(t){return this.options.header&&(t-=1),this.getData()[t]},e.prototype.getMaxOrder=function(){return this._data.length+this.options.startNum||0},e.prototype.setStartNum=function(t){var e=this.options.startNum||1;this.options.order&&t!==e&&(this.options.startNum=t,this._resetOrderNum(t),this.fire("orderchanged",this))},e.prototype.addTo=function(t){t&&(this._layer=t,this._initRowHeightAndColWidth(),this.tableSymbols||(this.tableSymbols=this._initCellSymbol()),this._tableRows=this.createTable(),this._addToLayer(this._tableRows,!0),this.addStretchLine(),this._addEventsToTable())},e.prototype._addEventsToTable=function(){this.options.editable&&this.on("dblclick",function(t){var e=t.context.cell;e&&this._addEditEventToCell(e)})},e.prototype.getLayer=function(){return this._layer},e.prototype.getMap=function(){return this._layer?this._layer.getMap():null},e.prototype.getCenter=function(){return this.getCoordinates()},e.prototype.getCoordinates=function(){var t=this.options.position;return new maptalks.Coordinate(t.x,t.y)},e.prototype.animate=function(t,e,i){var o=this.getAllCells();if(o&&o.length>0)for(var r=0,s=o.length;r<s;r++)o[r].animate(t,e,i)},e.prototype._initRowHeightAndColWidth=function(){if(0===this._rowHeights.length)for(var t=this._rowNum,e=0;e<t;e++)this._rowHeights[e]=this._cellHeight;if(0===this._colWidths.length)for(var i=0;i<this._colNum;i++)this._colWidths[i]=this._cellWidth},e.prototype._initCellSymbol=function(){for(var t={},e=this.options.headerSymbol||this.options.symbol,i=this.options.symbol,o=0;o<this._rowNum;o++)if(0===o&&this.options.header)for(var r=0;r<this._colNum;r++)t[o+"_"+r]=e;else for(var s=0;s<this._colNum;s++)t[o+"_"+s]=i;return t},e.prototype.hide=function(){for(var t,e=0,i=this._tableRows.length;e<i;e++){if(!(t=this._tableRows[e]))return;for(var o=0,r=t.length;o<r;o++)t[o].isEditingText()&&t[o].endEditText(),t[o].hide()}this.removeStretchLine(),this.fire("hide",this),this.options.visible=!1},e.prototype.show=function(){for(var t,e=0,i=this._tableRows.length;e<i;e++){if(!(t=this._tableRows[e]))return;for(var o=0,r=t.length;o<r;o++)t[o].show()}this.options.visible=!0},e.prototype.isVisible=function(){return this.options.visible},e.prototype.orderNumberIsVisible=function(){return this.options.showOrderNumber},e.prototype.showOrderNumber=function(){this._showNumLabel(),this.options.showOrderNumber=!0},e.prototype.hideOrderNumber=function(){this._hideNumLabel(),this.options.showOrderNumber=!1},e.prototype.getAllCells=function(){for(var t,e=[],i=0,o=this._tableRows.length;i<o;i++)if(t=this._tableRows[i])for(var r=0,s=t.length;r<s;r++)e.push(t[r]);return this.options.dynamic&&this.options.order&&(e=e.concat(this._geometryNumLabels)),e},e.prototype.remove=function(){this.stopEditTable();for(var t,e=0,i=this._tableRows.length;e<i;e++){if(!(t=this._tableRows[e]))return;for(var o=0,r=t.length;o<r;o++)t[o].remove()}this._tableRows=[],this.fire("remove",this),this.removeStretchLine(),this._deleteTable()},e.prototype.setZIndex=function(t){this._zindex=t;for(var e=0;e<this._rowNum;e++){var i=this._tableRows[e];if(!i)return;for(var o=0,r=i.length;o<r;o++)i[o].setZIndex(t)}},e.prototype.getZIndex=function(){return this._zindex},e.prototype.bringToFront=function(){for(var t=0;t<this._rowNum;t++){var e=this._tableRows[t];if(!e)return;for(var i=0,o=e.length;i<o;i++)e[i].bringToFront()}},e.prototype.bringToBack=function(){for(var t=0;t<this._rowNum;t++){var e=this._tableRows[t];if(!e)return;for(var i=0,o=e.length;i<o;i++)e[i].bringToBack()}},e.prototype.stopEditTable=function(){for(var t,e=0,i=this._tableRows.length;e<i;e++){if(!(t=this._tableRows[e]))return;for(var o=0,r=t.length;o<r;o++)t[o].isEditingText()&&t[o].endEditText()}},e.prototype.isEditing=function(){return this.options.editing},e.prototype._deleteTable=function(){delete this._initalColumns,delete this._headAttributes,delete this._columns,delete this._colNum,delete this._data,delete this._initalData,delete this._rowNum,delete this.tableWidth,delete this.tableHeight,delete this._cellWidth,delete this._cellHeight,delete this._currentRow,delete this._currentCol,delete this._rowHeights,delete this._colWidths,delete this.options,delete this._tableRows,delete this._layer,delete this},e.prototype.refreshData=function(t,e){for(var i=this.getData(),o=this._getUpdateItems(i,t,e),r=this._getMinusItems(i,t,e),s=this._getMinusItems(t,i,e),a=0;a<o.length;a++)this.updateRow(o[a].maptalks_order,o[a]);for(var n=r.length-1;n>=0;n--)this.removeRow(r[n].maptalks_order);var h=0;this.options.header&&(h=1);for(var l=this.getData().length-1,d=0;d<s.length;d++)this.addRow(l+d+h,s[d],!0)},e.prototype._uniquelize=function(t,e){if(!e)return[];for(var i=[],o=0;o<t.length;o++){for(var r=!0,s=0;s<i.length;s++)if(t[o][e]===i[s][e]){r=!1;break}r&&i.push(t[o])}return i},e.prototype._getUpdateItems=function(t,e,i){if(!i)return[];var o=[];t=this._uniquelize(t,i);for(var r=0;r<t.length;r++)for(var s=0;s<e.length;s++)if(e[s][i]===t[r][i]){e[s].maptalks_order=t[r].maptalks_order,o.push(e[s]);break}return o},e.prototype._getMinusItems=function(t,e,i){if(!i)return[];var o=[];t=this._uniquelize(t,i);for(var r=0;r<t.length;r++){for(var s=!0,a=0;a<e.length;a++)e[a][i]===t[r][i]&&(s=!1);s&&o.push(t[r])}return o},e.prototype.setCoordinates=function(t){var e=new maptalks.Coordinate(t.x,t.y),i=e.substract(this.getCenter());this._translate(i)},e.prototype._addToLayer=function(t,e){for(var i=void 0,o=void 0,r=0,s=t.length;r<s;r++){if(!(i=t[r]))return;for(var a=0,n=i.length;a<n;a++)o=i[a],e&&(o._row=r,o._col=a),this._addEventsToCell(o).addTo(this._layer)}},e.prototype._showHeaderItemMenu=function(t,e){for(var i=[],o=void 0,r=void 0,s=void 0,a=0,n=this._headAttributes.length;a<n;a++)o=this._headAttributes[a],r=o.displayName,s={item:r,click:this._changeHeader.apply(this,t)},i.push(s);var h={width:100,style:"grey",items:i};this.getMap().setMenu(h).openMenu(e)},e.prototype._changeHeader=function(t,e){var i=t.index,o=this._headAttributes[i];e.dataIndex=o.name,e.setContent(o.displayName),this._setColData(e);var r=e._col;this._columns[r]={header:o.displayName,dataIndex:o.name,type:"string"}},e.prototype._setColData=function(t){for(var e=t.dataIndex,i=t._col,o=[],r=void 0,s=0,a=this._initalData.length;s<a;s++)r=this._initalData[s],o[s+1]=r[e];for(var n=void 0,h=1,l=this._tableRows.length;h<l;h++){if(!(n=this._tableRows[h]))return;t=n[i],t.setContent(o[h])}},e.prototype._dragTableStart=function(){this.fire("dragstart",{target:this})},e.prototype._dragTableEnd=function(){this.fire("dragend",{target:this})},e.prototype._dragTable=function(){var t=event.dragOffset;this._translate(t),this.fire("moving dragging",{target:this})},e.prototype._translate=function(t){for(var e=void 0,i=void 0,o=0,r=this._tableRows.length;o<r;o++){if(!(e=this._tableRows[o]))return;for(var s=0,a=e.length;s<a;s++)i=e[s],i.translate(t),0===o&&0===s&&(this.options.position=i.getCenter())}},e.prototype._addMouseoverEvent=function(t){t.context=this,this.table.fire("mouseover",t)},e.prototype._addMouseoutEvent=function(t){t.context=this,this.table.fire("mouseout",t)},e.prototype._addMousedownEvent=function(t){t.context=this,this.table.fire("mousedown",t)},e.prototype._addClickEvent=function(t){t.context=this,this.table.fire("click",t)},e.prototype._addDBLClickEvent=function(t){t.context=this,this.table.fire("dblclick",t)},e.prototype._addContextmenuEvent=function(t){t.context=this,this.table.fire("contextmenu",t)},e.prototype._addEditTableEvent=function(t){t.context=this,this.table.fire("edittablestart",t),this.table.options.editing=!0},e.prototype.createTable=function(){for(var t,e=[],i=0;i<this._rowNum;i++)0===i&&this.options.header?e.push(this.createHeader()):(t=this._data[i],this._data&&this._data.length>0&&(this.options.header&&(t=this._data[i-1]),t&&e.push(this._createRow(i,t))));return e},e.prototype.getColumns=function(){var t=this.options.columns;if(!t){t=[];var e=this.options.data,i=void 0,o=void 0;for(var r in e)i=this._getDataType(e[r]),o={header:r,dataIndex:r,type:i},t.push(o)}return t},e.prototype._getDataType=function(t){var e="string";return maptalks.isNumber(t)&&(e="number"),e},e.prototype.setTableStyle=function(t,e,i){if(i){for(var o=0;o<this._rowNum;o++)this._setRowStyle(o,t,e);this._changeDefaultSymbol(t,e)}else{var r=this._currentRow,s=this._currentCol;r>-1&&this._setRowStyle(r,t,e),s>-1&&this._setColStyle(s,t,e)}},e.prototype._setRowStyle=function(t,e,i){for(var o=this._tableRows[t],r=0,s=o.length;r<s;r++){var a=o[r],n=a.getSymbol(),h=i;"textFont"===e&&(h=i+" "+n.textSize+"px "+n.textFaceName),this._setStyleToCell(a,e,h)}},e.prototype._setColStyle=function(t,e,i){for(var o=0,r=this._tableRows.length;o<r;o++){var s=this._tableRows[o],a=s[t],n=a.getSymbol(),h=i;"textFont"===e&&(h=i+" "+n.textSize+"px "+n.textFaceName),this._setStyleToCell(a,e,h)}},e.prototype._setStyleToCell=function(t,e,i){var o=t.getSymbol();"textAlign"===e?(o.textHorizontalAlignment=i,"left"===i?o.textDx-=t.getSize.width/2:"right"===i&&(o.textDx+=t.getSize.width/2),t.setSymbol(o)):(o[e]=i,t.setSymbol(o))},e.prototype._changeDefaultSymbol=function(t,e){var i=this.options.symbol;"textAlign"===t?i.textHorizontalAlignment=e:"textFont"===t?e=e+" "+i.textSize+"px "+i.textFaceName:"markerFill"===t?i.fill=e:"markerLineColor"===t&&(i.lineColor=e),i[t]=e,this.options.symbol=i},e}(maptalks.JSONAble(maptalks.Eventable(maptalks.Handlerable(maptalks.Class))));h.mergeOptions(a),h.registerJSONType("Table"),h.include({createCell:function(t,e,i,o){var r=o.textSize||12,s=o.textLineSpacing||8;t=this._filterContent(t);var a={symbol:{markerLineColor:o.lineColor||"#ffffff",markerLineWidth:1,markerLineOpacity:.9,markerLineDasharray:null,markerFill:o.fill||"#4e98dd",markerFillOpacity:.9,markerDx:e.dx||0,markerDy:e.dy||0,textFaceName:o.textFaceName||"microsoft yahei",textSize:r,textFill:o.textFill||"#ff0000",textOpacity:1,textSpacing:30,textWrapWidth:i.width,textWrapBefore:!1,textLineSpacing:s,textHorizontalAlignment:o.textHorizontalAlignment||"middle",textVerticalAlignment:o.textVerticalAlignment||"middle",textWeight:o.textWeight,textStyle:o.textStyle,textDx:e.dx||0,textDy:e.dy||0},boxPadding:{width:15,height:8},draggable:!1,boxAutoSize:!1,boxMinWidth:i.width,boxMinHeight:i.height},n=this.options.position;return new maptalks.TextBox(t,n,a)},getCellOffset:function(t,e){var i=0,o=0,r=this._cellWidth/2,s=this._cellHeight/2;if(this._rowHeights[t]&&(r=this._rowHeights[t]/2),this._colWidths[e]&&(s=this._colWidths[e]/2),this._tableRows){for(var a=0;a<t;a++)o+=this._rowHeights[a];o+=r;for(var n=0;n<e;n++)i+=this._colWidths[n];i+=s}else i=this._cellWidth*e+this._cellWidth/2,o=this._cellHeight*t+this._cellHeight/2;return{dx:i,dy:o}},getCellSymbol:function(t,e){var i=this.options.symbol;if(this.tableSymbols){var o=this.tableSymbols[t+"_"+e];if(o)return o.textLineSpacing||(o.textLineSpacing=i.textLineSpacing),o}return i},getRowNum:function(t){return t._row},getColNum:function(t){return t._col},_addEventsToCell:function(t){var e={table:this,cell:t,row:t._row,col:t._col,dataIndex:t.dataIndex};return t.on("mouseover",this._addMouseoverEvent,e).on("mouseout",this._addMouseoutEvent,e).on("mousedown",this._addMousedownEvent,e).on("click",this._addClickEvent,e).on("dblclick",this._addDBLClickEvent,e).on("contextmenu",this._addContextmenuEvent,e).on("symbolchange",this._cellSymbolChangeEvent,e).on("edittextstart",this._addEditTableEvent,e).on("edittextend",this._cellEditTextEnd,e),t},_cellSymbolChangeEvent:function(t){t.context=this;var e=this.table,i=this.cell;e.fire("symbolchange",t);var o=this.cell.getSymbol();e.tableSymbols[i._row+"_"+i._col]=e.convertCellToSaveSymbol(o)},_cellEditTextEnd:function(t){t.context=this;var e=this.table,i=this.cell,o=i._row,r=i._col,s=e._columns[r],a=s.dataIndex;e.options.header?o>0?(o-=1,e._data[o][a]=i.getContent()):e._columns[r].header=i.getContent():e._data[o][a]=i.getContent(),this.table.fire("edittableend",t),this.table.options.editing=!1},convertCellToSaveSymbol:function(t){return{fill:t.markerFill,lineColor:t.markerLineColor,textFaceName:t.textFaceName,textFill:t.textFill,textSize:t.textSize,textWrapWidth:t.textWrapWidth,textHorizontalAlignment:t.textHorizontalAlignment,textWeight:t.textWeight,textStyle:t.textStyle}},removeNumLabelByRowNum:function(t){for(var e=this._geometryNumLabels.length-1;e>=t-1;e--)this._geometryNumLabels[e].remove(),this._geometryNumLabels.splice(e,1)},_addEditEventToCell:function(t){t.startEditText();var e=t._textEditor;e.focus();var i=e.value;e.value="","\u7a7a"!==i&&(e.value=i);var o=this;t.on("remove",function(){t.isEditingText()&&t.endEditText()}),t.on("edittextend",function(){var e=t.getContent(),i=t._row,r=t._col,s=o._columns[r].dataIndex;o.options.header&&i>0?o._data[i-1][s]=e:o._columns[r].header=e})},_addNumberLabelToGeometry:function(t,e){var i=this,o=e.getSymbol(),r=this.getId()+"_"+this.getRowNum(e),s={id:r,symbol:this._convertCellSymbolToNumberSymbol(o),draggable:!1,boxAutoSize:!1,boxMinWidth:20,boxMinHeight:20},a=e.getContent(),n=this.getLayer().getGeometryById(r);n||(n=new maptalks.Label(a,t,s),this.getLayer().addGeometry(n)),this._geometryNumLabels.push(n);var h=this;e.on("remove",function(){h._removeNumLabel(n),n.remove()},this),e.on("hide",function(){n.hide()},this),e.on("show",function(){n.show()},this),e.on("contentchange",function(){var t=0;i.options.header&&(t=-1);var o=e._row+t,r=i._data[o],s=r.coordinate;s&&n.setCoordinates(new maptalks.Coordinate(s.x,s.y))},this),e.on("symbolchange",function(){var t=i._convertCellSymbolToNumberSymbol(e.getSymbol());i._changeNumLabelSymbol(n,t),n.setSymbol(t)},this),e.on("contentchange positionchanged",function(){var t=e.getContent();i._changeNumLabelContent(n,t),n.setContent(t)},this)},_hideNumLabel:function(){for(var t=0;t<this._geometryNumLabels.length;t++)this._geometryNumLabels[t].hide()},_showNumLabel:function(){for(var t=0;t<this._geometryNumLabels.length;t++)this._geometryNumLabels[t].show()},_removeNumLabel:function(t){for(var e=0;e<this._geometryNumLabels.length;e++)if(t===this._geometryNumLabels[e]){this._geometryNumLabels.splice(e,1);break}},_changeNumLabelSymbol:function(t,e){for(var i=0;i<this._geometryNumLabels.length;i++)if(t===this._geometryNumLabels[i]){this._geometryNumLabels[i].setSymbol(e);break}},_changeNumLabelContent:function(t,e){for(var i=0;i<this._geometryNumLabels.length;i++)if(t===this._geometryNumLabels[i]){this._geometryNumLabels[i].setContent(e);break}},_convertCellSymbolToNumberSymbol:function(t){return{markerType:"ellipse",markerLineColor:"#ffffff",markerLineWidth:0,markerLineOpacity:t.markerLineOpacity||0,markerFill:t.markerFill||"#4e98dd",markerFillOpacity:t.markerFillOpacity||1,markerDx:0,markerDy:0,markerHeight:30,markerWidth:30,textFaceName:t.textFaceName||"microsoft yahei",textSize:t.textSize||12,textFill:t.textFill||"#ff0000",textOpacity:t.textOpacity||1,textSpacing:t.textSpacing||0,textWrapBefore:!1,textLineSpacing:t.textLineSpacing||0,textHorizontalAlignment:t.textHorizontalAlignment||"middle",textVerticalAlignment:t.textVerticalAlignment||"middle",textDx:0,textDy:0}},_filterContent:function(t){return t+="",t.replace(/\r/gi,"").replace(/\v/gi,"").replace(/\f/gi,"").replace(/\t/gi,"").replace(/\b/gi,"").replace(/\n\n/gi,"\n")},isNumber:function(t){return"number"==typeof t&&!isNaN(t)}}),h.include({addCol:function(t,e,i){var o=t+1;return i||(o=t),this._createCol(o,e,!0),this},_createCol:function(t,e,i){this.removeStretchLine();var o=t;e&&0!==e.length||(e="");var r=[],s=1,a=void 0;if(maptalks.Util.isArrayHasData(e[0])){s=e.length,a=[];for(var n=0,h=e.length;n<h;n++)for(var l=0;l<this._rowNum;l++){var d=this._addCellForColumn(e[n][0],e[n][l],l,t+n,i);this._tableRows[l].splice(t+n,0,d)}r.push(a)}else for(var _=0;_<this._rowNum;_++){var c=this._addCellForColumn(e[0],e[_],_,t,i);this._tableRows[_].splice(t,0,c)}this._colNum+=s,this._adjustDatasetForCol(o,s)},_addCellForColumn:function(t,e,i,o,r){var s=void 0,a=void 0,n=void 0,h=void 0,l=void 0;if(r){var d=o-1,_=this.getCellOffset(i,d),c=this._colWidths[d];s=0===i?{dx:_.dx+(c+this._cellWidth)/2,dy:_.dy}:this.getCellOffset(i,o),a=this.options.symbol,this.options.header&&0===i&&(a=this.options.headerSymbol),h=this._cellWidth,n=new maptalks.Size(this._cellWidth,this._rowHeights[i])}else s=this.getCellOffset(i,o),a=this.getCellSymbol(i,o),h=this._colWidths[o],n=new maptalks.Size(h,this._rowHeights[i]);if(0===i){var g={header:t,dataIndex:t,type:"string"};this._columns.splice(o,0,g),l=this.createCell(t,s,n,a),this.tableWidth+=h,this._colWidths.splice(o,0,h)}else l=this.createCell(e,s,n,a),this.options.header&&--i,this._data[i][t]=e;return l._row=i,l._col=o,l.dataIndex=t,this.tableSymbols[i+"_"+o]=a,this._addEventsToCell(l).addTo(this._layer),l},moveCol:function(t,e){this.stopEditTable(),this.removeStretchLine();var i=t;"left"===e?t>0&&(i=t-1):"right"===e&&t<this._colNum-1&&(i=t+1),this._changeColOrder(t,i)},_changeColOrder:function(t,e){if(t!==e){var i=this._tableRows[0],o=i[t],r=o._row,s=o._col,a=this._colWidths[t],n=this.getCellOffset(r,s).dx,h=i[e],l=h._row,d=h._col,_=this._colWidths[e],c=this.getCellOffset(l,d).dx;n<c?(n+=_,c-=a):(n-=_,c+=a);for(var g=void 0,u=void 0,m=void 0,p=void 0,f=0,v=this._tableRows.length;f<v;f++){if(!(g=this._tableRows[f]))return;u=g[t].getSymbol(),u.markerDx=n,u.textDx=n,g[t].setSymbol(u),g[t]._col=e,m=g[e].getSymbol(),m.markerDx=c,m.textDx=c,g[e].setSymbol(m),g[e]._col=t,p=g[t],g[t]=g[e],g[e]=p}this._colWidths[t]=this._colWidths[e],this._colWidths[e]=a;var b=this._columns[t];this._columns[t]=this._columns[e],this._columns[e]=b}},_adjustDatasetForCol:function(t,e){for(var i=this.options.position,o=this._layer.getMap(),r=void 0,s=void 0,a=void 0,n=void 0,h=void 0,l=void 0,d=void 0,_=void 0,c=0,g=this._tableRows.length;c<g;c++){if(!(r=this._tableRows[c]))return;for(var u=t+1,m=r.length;u<m;u++)s=r[u],s._col+=e,s.fire("symbolchange",s),this._translateDx(s,this._cellWidth),0===c&&this._adjustCols&&(a=this._adjustCols[u],n=s.getSize(),h=s.getSymbol(),l=h.textDx,d=o.locate(i,o.pixelToDistance(n.width/2+l,0),o.pixelToDistance(0,n.height/2)),_=o.locate(d,0,-o.pixelToDistance(0,this.tableHeight)),a.setCoordinates([d,_]))}},removeCol:function(t){this.stopEditTable(),this.removeStretchLine();for(var e=this._tableRows[0],i=e[t],o=i.getSize(),r=this.options.position,s=this._layer.getMap(),a=void 0,n=void 0,h=void 0,l=void 0,d=void 0,_=void 0,c=void 0,g=void 0,u=0,m=this._tableRows.length;u<m;u++){if(!(a=this._tableRows[u]))return;for(var p=t,f=a.length;p<f;p++)n=a[p],0===u&&p===t&&(this.tableWidth-=o.width),p>t?(this._translateDx(n,1-o.width),0===u&&this._adjustCols&&(h=this._adjustCols[n._col],l=n.getSize(),d=n.getSymbol(),_=d.textDx,c=s.locate(r,s.pixelToDistance(l.width/2+_,0),s.pixelToDistance(0,l.height/2)),g=s.locate(c,0,-s.pixelToDistance(0,this.tableHeight)),h.setCoordinates([c,g])),n._col-=1):n.remove();this._tableRows[u].splice(t,1),this.options.header?u>0&&delete this._data[u-1][i.dataIndex]:delete this._data[u][i.dataIndex]}this._colWidths.splice(t,1),this._columns.splice(t,1),this._colNum-=1},_translateDx:function(t,e){var i=t.getSymbol();i.markerDx+=e,i.textDx+=e,t.setSymbol(i)}});var l=maptalks.INTERNAL_LAYER_PREFIX+"_drag_stage",d=maptalks.Browser.touch?"touchstart mousedown":"mousedown",_=function(t){function e(i){return o(this,e),s(this,t.call(this,i))}return r(e,t),e.prototype.addHooks=function(){this.target.on(d,this._startDrag,this)},e.prototype.removeHooks=function(){this.target.off(d,this._startDrag,this)},e.prototype._startDrag=function(t){if(this.target.getMap()&&!this._isDragging){var e=t.domEvent;e.touches&&e.touches.length>1||(this.target.on("click",this._endDrag,this),this.target.removeStretchLine(),this._lastPos=t.coordinate,this._prepareMap(),this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this._moved=!1,this.target.fire("dragstart",t))}},e.prototype._prepareMap=function(){var t=this.target.getMap();this._mapDraggable=t.options.draggable,this._mapHitDetect=t.options.hitDetect,t._trySetCursor("move"),t.config({hitDetect:!1,draggable:!1})},e.prototype._prepareDragHandler=function(){var t=this.target.getMap();this._dragHandler=new maptalks.DragHandler(t._panels.mapWrapper||t._containerDOM),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},e.prototype._prepareShadow=function(){var t=this.target;this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var e=t.tableWidth,i=t.tableHeight;this._shadow=new maptalks.Marker(t.getCenter(),{draggable:!0,symbol:{markerType:"square",markerLineColor:"#ffffff",markerLineDasharray:[5,5,2,5],markerFill:"#4e98dd",markerFillOpacity:.2,markerWidth:e,markerHeight:i,markerDx:e/2,markerDy:i/2}});var o=this._shadow;if(t.options.dragShadow){var r=maptalks.Util.decreaseSymbolOpacity(o._getInternalSymbol(),.5);o.setSymbol(r)}o.setId(null);var s=[];this._shadowConnectors=s,this._dragStageLayer.bringToFront().addGeometry(s.concat(o))},e.prototype._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target.getSymbol())},e.prototype._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer(l),this._dragStageLayer||(this._dragStageLayer=new maptalks.VectorLayer(l,{drawImmediate:!0}),t.addLayer(this._dragStageLayer)),this._dragStageLayer._getRenderer()._resources=e._getRenderer()._resources},e.prototype._dragging=function(t){var e=this.target,i=e.getMap(),o=i._parseEvent(t.domEvent),r=o.domEvent;if(!(r.touches&&r.touches.length>1)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._prepareMap(),this._isDragging=!0,this._prepareShadow(),void this._shadow._fireEvent("dragstart",o);if(this._shadow){var s=o.coordinate;this._lastPos||(this._lastPos=s);var a=s.substract(this._lastPos),n=this._shadow.options.dragOnAxis;"x"===n?a.y=0:"y"===n&&(a.x=0),this._lastPos=s,this._shadow.translate(a),o.dragOffset=a,this._shadow._fireEvent("dragging",o),e.fire("dragging",o)}}},e.prototype._endDrag=function(t){var e=this.target,i=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),i){var o;i&&(o=i._parseEvent(t.domEvent)),e.off("symbolchange",this._onTargetUpdated,this);var r=this._shadow;r&&(e.setCoordinates(r.getCoordinates()),r._fireEvent("dragend",o),r.remove(),delete this._shadow),this._shadowConnectors&&(i.getLayer(l).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),delete this._lastPos,i._trySetCursor("default"),maptalks.Util.isNil(this._mapDraggable)&&(this._mapDraggable=!0),i.config({hitDetect:this._mapHitDetect,draggable:!0}),delete this._autoBorderPanning,delete this._mapDraggable,this._isDragging=!1,e.fire("dragend",o)}},e}(maptalks.Handler);h.addInitHook("addHandler","draggable",_),h.include({isDragging:function(){return!!this._isDragging}}),h.include({createHeader:function(){for(var t=[],e=void 0,i=void 0,o=void 0,r=void 0,s=void 0,a=0,n=this._columns.length;a<n;a++){e=this.getCellOffset(0,a),i=this._columns[a],o=i.header,r=new maptalks.Size(this._colWidths[a],this._rowHeights[0]);var h=this.getCellSymbol(0,a);s=this.createCell(o,e,r,h),s._row=0,s._col=a,s.dataIndex=i.dataIndex,t.push(s)}return this.tableHeight+=this._rowHeights[0],t}}),h.include({addRow:function(t,e,i){var o=t;i&&(o=t+1);var r=[];if(e&&0!==e.length)if(maptalks.Util.isArrayHasData(e))for(var s=void 0,a=0,n=e.length;a<n;a++)s=e[a],r.push(this._createRow(o,s,!0)),o+=1;else{var h=this._createRow(o,e,!0);r.push(h)}else r.push(this._createRow(o,e,!0));this._addToLayer(r);var l=this._tableRows.slice(0,o+1),d=this._tableRows.slice(o+1);return this._adjustDatasetForRow(r.length,d),this._tableRows=l.concat(r).concat(d),this._rowNum+=r.length,this.fire("addrow",this),this.fire("orderchanged",this),this},moveRow:function(t,e){this.stopEditTable(),this.removeStretchLine();var i=t;"up"===e?t>0&&(i=t-1):"down"===e&&t<this._rowNum-1&&(i=t+1),this._changeRowOrder(t,i)},updateRow:function(t,e){this.removeStretchLine(),t-=parseInt(this.options.startNum||1);var i=t;this.options.header&&(i=t+1);var o=this._tableRows[i];if(o){this._data[t]=e;for(var r=void 0,s=void 0,a=0;a<this._colNum;a++){r=this._columns[a].dataIndex,s="",e&&e[r]&&(s=e[r]);var n=o[a];n&&(this.options.order&&"maptalks_order"===r&&(s=n.getContent()),n.setContent(s))}}},removeRow:function t(e){this.stopEditTable(),this.removeStretchLine();for(var t=this._tableRows[e],i=t[0],o=i.getSize(),r=void 0,s=void 0,a=e,n=this._tableRows.length;a<n;a++){if(!(r=this._tableRows[a]))return;for(var h=0,l=r.length;h<l;h++)if(s=r[h],a>e){if(s._row-=1,this.options.order&&"maptalks_order"===this._columns[h].dataIndex){var d=this.options.startNum||1;d>1?s.setContent(s._row+d):s.setContent(s._row)}this._translateDy(s,1-o.height)}else s.remove()}this.tableHeight-=o.height+1,this._tableRows.splice(e,1),this._rowHeights.splice(e,1);var _=0;this.options.header?(this._data.splice(e-1,1),_=e-1):(this._data.splice(e,1),_=e),this.removeNumLabelByRowNum(e);for(var c=_;c<this._data.length;c++)this._data[c].maptalks_order-=1;this._rowNum-=1,this.fire("removerow",this),this.fire("orderchanged",this)},_createRow:function(t,e,i){this.removeStretchLine();var o=[],r=void 0,s=void 0,a=void 0,n=void 0,h=void 0,l=void 0,d=void 0,_=void 0,c=this._rowHeights[t];c||(c=this._cellHeight);for(var g=0;g<this._colNum;g++){if(r=this._columns[g],s=r.dataIndex,a="",e&&e[s]&&(a=e[s]),this.options.order&&"maptalks_order"===s){if(!a||""===a){var u=this.options.startNum||1;a=u>1?t+u-1:t}e[s]=a}if(i){var m=this.getCellOffset(t-1,g);n={dx:m.dx,dy:m.dy+c},_=this.options.symbol,h=new maptalks.Size(this._colWidths[g],c)}else n=this.getCellOffset(t,g),_=this.getCellSymbol(t,g),h=new maptalks.Size(this._colWidths[g],c);l=this.createCell(a,n,h,_),l._row=t,l._col=g,l.dataIndex=s,o[g]=l,this.tableSymbols[t+"_"+g]=_,this.options.dynamic&&this.options.order&&"maptalks_order"===s&&(d=e.coordinate)&&this._addNumberLabelToGeometry(new maptalks.Coordinate(d.x,d.y),l)}return this.tableHeight+=i?this._cellHeight:c,i&&(this._rowHeights.splice(t,0,this._cellHeight),this.options.header&&--t,this._data.splice(t,0,e)),o},_changeRowOrder:function(t,e){if(t!==e){var i=0;if(this.options.header&&(i=-1),0!==e){var o=this._tableRows[t],r=this._tableRows[e],s=o[0],a=s._row,n=s._col,h=this._rowHeights[a],l=this.getCellOffset(a,n).dy,d=r[0],_=d._row,c=d._col,g=this._rowHeights[_],u=this.getCellOffset(_,c).dy;l<u?(l+=g,u-=h):(l-=g,u+=h);for(var m=0,p=o.length;m<p;m++){var f=o[m].getSymbol();o[m]._row=e,f.markerDy=l,f.textDy=l,o[m].setSymbol(f),this.options.order&&"maptalks_order"===this._columns[m].dataIndex&&(o[m].setContent(e),this._data[t+i].maptalks_order=e,o[m].fire("positionchanged",{target:o[m]}))}for(var v=0,b=r.length;v<b;v++){var y=r[v].getSymbol();r[v]._row=t,y.markerDy=u,y.textDy=u,r[v].setSymbol(y),this.options.order&&"maptalks_order"===this._columns[v].dataIndex&&(r[v].setContent(t),this._data[e+i].maptalks_order=t,r[v].fire("positionchanged",{target:r[v]}))}this._tableRows[e]=o,this._tableRows[t]=r;var w=this._data[t+i];this._data[t+i]=this._data[e+i],this._data[e+i]=w,this._rowHeights[t]=this._rowHeights[e],this._rowHeights[e]=h}}},_adjustDatasetForRow:function(t,e){var i,o=0;this.options.header&&(o=-1);for(var r=0,s=e.length;r<s;r++){i=e[r];for(var a=0,n=i.length;a<n;a++){if(i[a]._row+=t,
this.options.order&&"maptalks_order"===this._columns[a].dataIndex){var h=i[a]._row,l=this.options.startNum||1;l>1&&(h+=l),i[a].setContent(h),this._data[i[a]._row+o].maptalks_order=h}i[a].fire("symbolchange",i[a]),this._translateDy(i[a],this._cellHeight)}}return this},_resetOrderNum:function(t){if(this.options.order){var e=0;this.options.header&&(e=-1);var i=0;this.options.header&&(i=1);for(var o=i,r=this._tableRows.length;o<r;o++)for(var s=this._tableRows[o],a=0;a<s.length;a++)if("maptalks_order"===s[a].dataIndex){var n=o+t+e;s[a].setContent(n),s[a].fire("positionchanged",{target:s[a]}),this._data[o+e].maptalks_order=n;break}}},_translateDy:function(t,e){var i=t.getSymbol();i.markerDy+=e,i.textDy+=e,t.setSymbol(i)}}),h.include({addStretchLine:function(){var t=this;this.on("mouseover",function(e){var i=t.getMap();i.options.doubleClickZoom=!1;var o=e.viewPoint,r=t._checkPointOnBottomEdge(o);return r?void t._createStretchLineForRow(i,o,r):(r=t._checkPointOnRightEdge(o),r?void t._createStretchLineForCol(i,o,r):void 0)}),this.on("mouseout",function(){t.getMap().options.doubleClickZoom=!0}).on("dragstart",this.removeStretchLine),this.getMap().on("movestart dragstart zoomstart resize",this.removeStretchLine,this)},_checkPointOnBottomEdge:function(t){if(this._mouseMoveStartPoint){if(this._mouseMoveStartPoint.distanceTo(t)>2)return this._mouseMoveStartPoint=t,!1}this._mouseMoveStartPoint=t;var e=this._getStretchStartPoint(t);t=new maptalks.Point(e.x,t.y);for(var i=e.distanceTo(t),o=0,r=!1,s=0;s<this._rowHeights.length;s++)if((o+=this._rowHeights[s])-1<=i&&i<=o+1){this._stretchRowNum=s,r=o;break}return r},_getStretchStartPoint:function(){var t=this.options.position;return this.getMap().coordinateToViewPoint(t)},_createStretchLineForRow:function(t,e,i){this._colLine&&(this._colLine.remove(),delete this._colLine);var o=this._getStretchStartPoint(e),r=o.add(new maptalks.Point(0,i)),s=t.viewPointToCoordinate(r),a=t.locate(s,t.pixelToDistance(this.tableWidth,0),0),n=[s,a];if(this._rowLine)this._rowLine.setCoordinates(n);else{this._rowLine=new maptalks.LineString(n,{draggable:!0,dragOnAxis:"y",cursor:"s-resize",symbol:{lineColor:"#ff0000",lineWidth:2,lineDasharray:null,lineOpacity:.8}}).addTo(this.getLayer());var h=this;this._rowLine.on("dragstart",function(t){h._startCoordinate=t.coordinate,h._startViewPoint=t.viewPoint}),this._rowLine.on("dragend",function(t){var e=t.coordinate.substract(h._startCoordinate),i=t.viewPoint,o=i.substract(h._startViewPoint);h._rowHeights[h._stretchRowNum]+o.y>5?(e.x=0,h._resizeRow(e)):(e.x=e.x*-1,e.y=e.y*-1,h._rowLine.translate(e)),h.getMap().config({draggable:!0})})}this._rowLine.show(),this._rowLine.bringToFront()},_resizeRow:function(t){var e,i,o,r=this.getMap().coordinateToPoint(t),s=r.y,a=this._rowHeights[this._stretchRowNum]+s;this.tableHeight+=s,this._rowHeights[this._stretchRowNum]=a;for(var n=this._stretchRowNum;n<this._rowNum;n++){e=this._tableRows[n];for(var h=0;h<this._colNum;h++)i=e[h],o=i.getSymbol(),n===this._stretchRowNum?(i.options.boxMinHeight=a,i.options.boxMinHeight<o.markerHeight&&(o.markerHeight=i.options.boxMinHeight),o.markerDy+=s/2,o.textDy+=s/2):(o.markerDy+=s,o.textDy+=s),i.setSymbol(o)}},_checkPointOnRightEdge:function(t){if(this._mouseMoveStartPoint){if(this._mouseMoveStartPoint.distanceTo(t)>2)return this._mouseMoveStartPoint=t,!1}this._mouseMoveStartPoint=t;var e=this._getStretchStartPoint(t);t=new maptalks.Point(t.x,e.y);for(var i=e.distanceTo(t),o=0,r=!1,s=0;s<this._colWidths.length;s++)if((o+=this._colWidths[s])-1<=i&&i<=o+1){this._stretchColNum=s,r=o;break}return r},_createStretchLineForCol:function(t,e,i){this._rowLine&&(this._rowLine.remove(),delete this._rowLine);var o=this._getStretchStartPoint(e),r=o.add(new maptalks.Point(i,0)),s=t.viewPointToCoordinate(r),a=t.locate(s,0,-t.pixelToDistance(0,this.tableHeight)),n=[s,a];if(this._colLine)this._colLine.setCoordinates(n);else{this._colLine=new maptalks.LineString(n,{draggable:!0,dragShadow:!1,dragOnAxis:"x",cursor:"e-resize",symbol:{lineColor:"#ff0000",lineWidth:2,lineDasharray:null,lineOpacity:.8}}).addTo(this.getLayer());var h=this;this._colLine.on("dragstart",function(t){h._startCoordinate=t.coordinate,h._startViewPoint=t.viewPoint}),this._colLine.on("dragend",function(t){var e=t.coordinate.substract(h._startCoordinate),i=t.viewPoint,o=i.substract(h._startViewPoint);h._colWidths[h._stretchColNum]+o.x>8?(e.y=0,h._resizeCol(e)):(e.x=e.x*-1,e.y=e.y*-1,h._colLine.translate(e)),h.getMap().config({draggable:!0})})}this._colLine.show(),this._colLine.bringToFront()},_resizeCol:function(t){var e,i,o,r=this.getMap().coordinateToPoint(t),s=r.x,a=this._colWidths[this._stretchColNum]+s;this.tableWidth+=s,this._colWidths[this._stretchColNum]=a;for(var n=0,h=this._tableRows.length;n<h;n++){if(!(e=this._tableRows[n]))return;for(var l=this._stretchColNum,d=e.length;l<d;l++)i=e[l],o=i.getSymbol(),l===this._stretchColNum?(i.options.boxMinWidth=a,o.markerWidth=i.options.boxMinWidth,o.textWrapWidth=i.options.boxMinWidth,o.markerDx+=s/2,o.textDx+=s/2):(o.markerDx+=s,o.textDx+=s),i.setSymbol(o)}},removeStretchLine:function(){this.getMap().off("movestart dragstart zoomstart resize",this.removeStretchLine,this),this._rowLine&&(this._rowLine.remove(),delete this._rowLine),this._colLine&&(this._colLine.remove(),delete this._colLine)}}),t.Table=h,Object.defineProperty(t,"__esModule",{value:!0})});